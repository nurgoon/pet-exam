from django.core.management.base import BaseCommand
from django.db import transaction

from exams.models import Attempt, Exam, Option, Question


SEED = [
    {
        'title': 'Аренда: Операции и процессы',
        'description': 'Проверка знаний по процессу выдачи, возврата и документообороту в прокате.',
        'subject': 'Операции',
        'duration_minutes': 25,
        'passing_score': 75,
        'questions': [
            {
                'prompt': 'Что обязательно нужно сделать перед выдачей перфоратора клиенту?',
                'topic': 'Выдача',
                'difficulty': 'easy',
                'options': [
                    ('a', 'Только оформить чек'),
                    ('b', 'Проверить комплектность, состояние и зафиксировать акт выдачи'),
                    ('c', 'Сразу закрыть заказ в системе'),
                    ('d', 'Передать инструмент без проверки, если клиент постоянный'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Как правильно учитывать повреждение, найденное при возврате?',
                'topic': 'Возврат',
                'difficulty': 'medium',
                'options': [
                    ('a', 'Не фиксировать, если клиент обещал оплатить потом'),
                    ('b', 'Зафиксировать в акте возврата с фото и комментарием менеджера'),
                    ('c', 'Списать инструмент сразу без согласования'),
                    ('d', 'Оставить решение на следующую смену'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Почему важно отмечать серийный номер в договоре аренды?',
                'topic': 'Документы',
                'difficulty': 'easy',
                'options': [
                    ('a', 'Это требуется только для дорогого оборудования'),
                    ('b', 'Для однозначной идентификации конкретной единицы оборудования'),
                    ('c', 'Чтобы ускорить печать договора'),
                    ('d', 'Для красоты документа'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Что делать, если клиент просит продлить аренду после истечения срока?',
                'topic': 'Продление',
                'difficulty': 'medium',
                'options': [
                    ('a', 'Продлить устно без изменений в системе'),
                    ('b', 'Оформить продление в системе и обновить финансовые условия'),
                    ('c', 'Попросить вернуть и заново выдать без документов'),
                    ('d', 'Игнорировать, если просрочка до 1 дня'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Какая метрика лучше всего показывает дисциплину возвратов?',
                'topic': 'KPI',
                'difficulty': 'hard',
                'options': [
                    ('a', 'Средняя длина названия инструмента'),
                    ('b', 'Доля возвратов в срок'),
                    ('c', 'Количество менеджеров в смене'),
                    ('d', 'Количество печатей на договоре'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Что важно проверить при приемке оборудования после сервиса?',
                'topic': 'Сервис',
                'difficulty': 'medium',
                'options': [
                    ('a', 'Только внешний вид коробки'),
                    ('b', 'Работоспособность, комплектность и отметку о выполненных работах'),
                    ('c', 'Только дату производства'),
                    ('d', 'Ничего, если сервис авторизованный'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Какой порядок действия при потере клиентом аксессуара (например, ключа патрона)?',
                'topic': 'Претензии',
                'difficulty': 'medium',
                'options': [
                    ('a', 'Закрыть заказ без замечаний'),
                    ('b', 'Оформить недостачу в акте и рассчитать компенсацию по правилам компании'),
                    ('c', 'Списать за счет склада'),
                    ('d', 'Перенести на другой заказ'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Зачем фиксировать фактическое время выдачи и возврата в системе?',
                'topic': 'Учет',
                'difficulty': 'easy',
                'options': [
                    ('a', 'Это не влияет на бизнес-процесс'),
                    ('b', 'Для корректного расчета аренды, аналитики загрузки и разрешения споров'),
                    ('c', 'Только для отчетности налоговой'),
                    ('d', 'Чтобы реже общаться с клиентом'),
                ],
                'correct_key': 'b',
            },
        ],
    },
    {
        'title': 'Аренда: Безопасность и техника',
        'description': 'Проверка знаний по безопасной эксплуатации, инструктажу и техническому состоянию.',
        'subject': 'Безопасность',
        'duration_minutes': 20,
        'passing_score': 80,
        'questions': [
            {
                'prompt': 'Что обязан сделать сотрудник перед передачей отбойного молотка клиенту?',
                'topic': 'Инструктаж',
                'difficulty': 'easy',
                'options': [
                    ('a', 'Передать только зарядное устройство'),
                    ('b', 'Провести базовый инструктаж по безопасному применению и ограничениям'),
                    ('c', 'Попросить клиента прочитать инструкцию дома'),
                    ('d', 'Не делать ничего, если клиент опытный'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Какой признак указывает, что электроинструмент нельзя выдавать в аренду?',
                'topic': 'Диагностика',
                'difficulty': 'easy',
                'options': [
                    ('a', 'Незначительная пыль на корпусе'),
                    ('b', 'Поврежденный кабель питания/изоляция'),
                    ('c', 'Небольшая царапина на кейсе'),
                    ('d', 'Отсутствие фирменной наклейки'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Почему нельзя скрывать замечания по техсостоянию в карточке оборудования?',
                'topic': 'Риски',
                'difficulty': 'medium',
                'options': [
                    ('a', 'Это ухудшает дизайн интерфейса'),
                    ('b', 'Это повышает риск травм, поломок и юридических претензий'),
                    ('c', 'Это влияет только на KPI маркетинга'),
                    ('d', 'Это важно только для нового оборудования'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Какая практика правильна для учета расходников (диски, буры, цепи)?',
                'topic': 'Расходники',
                'difficulty': 'medium',
                'options': [
                    ('a', 'Не учитывать, пока клиент не пожалуется'),
                    ('b', 'Выдавать и учитывать отдельно, с условиями возврата/списания'),
                    ('c', 'Всегда включать в цену аренды без детализации'),
                    ('d', 'Передавать без фиксации, если заказ крупный'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Какой документ/шаг критичен при выдаче генератора?',
                'topic': 'Электробезопасность',
                'difficulty': 'hard',
                'options': [
                    ('a', 'Только товарный чек'),
                    ('b', 'Фиксация инструктажа и проверка комплекта/уровней/выходных параметров'),
                    ('c', 'Только фото генератора с одной стороны'),
                    ('d', 'Подпись кладовщика без клиента'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Что делать с оборудованием после жалобы клиента на посторонний шум?',
                'topic': 'Инциденты',
                'difficulty': 'medium',
                'options': [
                    ('a', 'Сразу выдать следующему клиенту'),
                    ('b', 'Снять с выдачи и отправить на диагностику с отметкой причины'),
                    ('c', 'Сбросить ошибку и продолжать работу'),
                    ('d', 'Оставить на складе без статуса'),
                ],
                'correct_key': 'b',
            },
        ],
    },
    {
        'title': 'Аренда: Клиентский сервис и продажи',
        'description': 'Проверка знаний по подбору оборудования, коммуникации и обработке спорных ситуаций.',
        'subject': 'Сервис',
        'duration_minutes': 20,
        'passing_score': 75,
        'questions': [
            {
                'prompt': 'Какой первый шаг при подборе оборудования клиенту?',
                'topic': 'Подбор',
                'difficulty': 'easy',
                'options': [
                    ('a', 'Сразу предложить самый дорогой вариант'),
                    ('b', 'Уточнить задачу, условия работ и срок аренды'),
                    ('c', 'Спросить только бюджет'),
                    ('d', 'Передать выбор на склад без деталей'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Как корректно объяснить клиенту причину залога?',
                'topic': 'Коммуникация',
                'difficulty': 'medium',
                'options': [
                    ('a', 'Потому что так принято у всех'),
                    ('b', 'Как стандарт защиты оборудования и ответственности сторон по договору'),
                    ('c', 'Чтобы увеличить выручку любой ценой'),
                    ('d', 'Без объяснений, просто требовать оплату'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Что делать при конфликте по начислению за просрочку?',
                'topic': 'Конфликты',
                'difficulty': 'hard',
                'options': [
                    ('a', 'Сразу отменить начисление без проверки'),
                    ('b', 'Проверить таймстемпы, договор, акты и предложить прозрачный расчет'),
                    ('c', 'Передать в чат без обратной связи клиенту'),
                    ('d', 'Игнорировать, если сумма небольшая'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Какой апселл уместен при аренде резчика швов?',
                'topic': 'Продажи',
                'difficulty': 'medium',
                'options': [
                    ('a', 'Предложить нерелевантный товар'),
                    ('b', 'Предложить расходники и СИЗ, необходимые для выполнения задачи'),
                    ('c', 'Предложить купить оборудование вместо аренды без запроса'),
                    ('d', 'Ничего не предлагать из принципа'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Какая формулировка лучше в клиентской коммуникации?',
                'topic': 'Тон общения',
                'difficulty': 'easy',
                'options': [
                    ('a', 'Мы ничего не обязаны'),
                    ('b', 'Давайте проверим детали заказа и предложим оптимальное решение'),
                    ('c', 'Это ваша проблема'),
                    ('d', 'Читайте договор сами'),
                ],
                'correct_key': 'b',
            },
            {
                'prompt': 'Когда стоит предложить замену оборудования клиенту?',
                'topic': 'Сервис',
                'difficulty': 'medium',
                'options': [
                    ('a', 'Только если клиент сам настаивает'),
                    ('b', 'Если текущая модель не закрывает задачу или есть риск срыва работ'),
                    ('c', 'Никогда, это снижает маржу'),
                    ('d', 'Только в конце аренды'),
                ],
                'correct_key': 'b',
            },
        ],
    },
]

DIFFICULTY_SCORE = {
    'easy': 1,
    'medium': 2,
    'hard': 3,
}


class Command(BaseCommand):
    help = 'Загружает профильный банк экзаменов для компании по аренде строительного оборудования.'

    def add_arguments(self, parser):
        parser.add_argument('--reset', action='store_true', help='Очистить текущие экзамены перед загрузкой')

    @transaction.atomic
    def handle(self, *args, **options):
        if options['reset']:
            Attempt.objects.all().delete()
            Exam.objects.all().delete()
            self.stdout.write(self.style.WARNING('Существующие экзамены удалены.'))

        created_questions = 0
        created_options = 0

        for exam_data in SEED:
            exam, created = Exam.objects.get_or_create(
                title=exam_data['title'],
                defaults={
                    'description': exam_data['description'],
                    'subject': exam_data['subject'],
                    'duration_minutes': exam_data['duration_minutes'],
                    'passing_score': exam_data['passing_score'],
                    'is_active': True,
                },
            )

            if not created:
                exam.description = exam_data['description']
                exam.subject = exam_data['subject']
                exam.duration_minutes = exam_data['duration_minutes']
                exam.passing_score = exam_data['passing_score']
                exam.is_active = True
                exam.save()
                exam.questions.all().delete()

            for q_order, q_data in enumerate(exam_data['questions'], start=1):
                correct_key = q_data['correct_key']
                correct_text = next((text for key, text in q_data['options'] if key == correct_key), '')
                question = Question.objects.create(
                    exam=exam,
                    prompt=q_data['prompt'],
                    explanation=q_data.get('explanation', f"Верный вариант: {correct_text}"),
                    topic=q_data['topic'],
                    difficulty=q_data['difficulty'],
                    score_value=q_data.get('score_value', DIFFICULTY_SCORE.get(q_data['difficulty'], 1)),
                    order=q_order,
                )
                created_questions += 1

                for o_order, (key, text) in enumerate(q_data['options'], start=1):
                    Option.objects.create(
                        question=question,
                        text=text,
                        is_correct=(key == correct_key),
                        order=o_order,
                    )
                    created_options += 1

        self.stdout.write(
            self.style.SUCCESS(
                f'Готово. Экзамены: {Exam.objects.count()}, вопросов: {created_questions}, вариантов: {created_options}.'
            )
        )
